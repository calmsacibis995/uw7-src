#!/bin/sh
#ident	"@(#)addsl	1.2"
#
# Copyrighted as an unpublished work.
# (c) Copyright 1987-1995 Legent Corporation
# All rights reserved.
#
#      SCCS IDENTIFICATION
#       @(#) addsl 25.3 95/03/09 
#
#       Copyright (C) 1988-1995 The Santa Cruz Operation, Inc.
#               All Rights Reserved.
#       The information in this file is provided for the exclusive use of
#       the licensees of The Santa Cruz Operation, Inc.  Such users have the
#       right to use, modify, and incorporate this code into other products
#       for purposes authorized by the license agreement provided they include
#       this notice and the associated copyright notice with any such product.
#       The information in this file is provided "AS IS" without warranty.
#

check_hosts() {
	_IP=$1
	_HOST=$2

	if [ ! -f /etc/inet/hosts ]
	then
		return
	fi

	if egrep -i "^$_IP[ 	]+$_HOST$" /etc/inet/hosts > /dev/null 2>&1 || \
	   egrep -i "^$_IP[ 	]+$_HOST[ 	]" /etc/inet/hosts > \
		/dev/null 2>&1
	then
		: done
	else
		if [ "$_HOST" ]
		then
			echo "$_IP\t$_HOST" >> /etc/inet/hosts
		fi
	fi
}

# main Main MAIN

OK=0
FAIL=1
CANCEL=3

TMPDIR=/usr/lib/netcfg/tmp

CONT=Yes
while [ "$CONT" = "Yes" ]
do
	#
	# Select the type of link we want to configure.
	#

	/usr/lib/netcfg/bin/slip_type
	result=$?

	if [ $result -eq $CANCEL ]
	then
		#
		# User selected CANCEL in the prompter.
		#
		rm -f ${TMPDIR}/slip_type
		exit $CANCEL
	fi

	if [ $result -eq 1 ]
	then
		echo "$0: Error in /usr/lib/netcfg/bin/slip_type\n" >&2
		rm -f ${TMPDIR}/slip_type
		exit $FAIL
	fi

	LINK_TYPE=`cat ${TMPDIR}/slip_type`
	rm -f ${TMPDIR}/slip_type

	case "$LINK_TYPE" in
		static)
			ncfgprompter /usr/lib/netcfg/bin/slip.BE STATIC > \
				${TMPDIR}/slip.conf
			case $? in
				0)
					;;
				1)
					echo "Error in /usr/lib/netcfg/bin/slip.BE"
					rm -f ${TMPDIR}/slip.conf
					exit $FAIL
					;;
				3)
					#
					# User selected CANCEL in the prompter.
					#
					rm -f ${TMPDIR}/slip.conf
					exit $CANCEL
					;;
				*)
					echo "Error in /usr/lib/netcfg/bin/slip.BE"
					rm -f ${TMPDIR}/slip.conf
					exit $FAIL
					;;
			esac
			;;
		incoming)
			ncfgprompter /usr/lib/netcfg/bin/slip.BE INC > \
				${TMPDIR}/slip.conf
			case $? in
				0)
					;;
				1)
					echo "Error in /usr/lib/netcfg/bin/slip.BE"
					rm -f ${TMPDIR}/slip.conf
					exit $FAIL
					;;
				3)
					#
					# User selected CANCEL in the prompter.
					#
					rm -f ${TMPDIR}/slip.conf
					exit $CANCEL
					;;
				*)
					echo "Error in /usr/lib/netcfg/bin/slip.BE"
					rm -f ${TMPDIR}/slip.conf
					exit $FAIL
					;;
			esac
	esac

	if [ "$LINK_TYPE" = "static" ]
	then
		. ${TMPDIR}/slip.conf
		rm -f ${TMPDIR}/slip.conf

		#
		# Create an entry in /etc/init.d/inetinit based on the
		# information given.
		#
		SLATTACH=""

		if [ "$SLIP_ARP" = "On" ]
		then
			SLATTACH="$SLATTACH +a"
		fi

		if [ "$SLIP_COMP" = "On" ]
		then
			SLATTACH="$SLATTACH +c"
		else
			if [ "$SLIP_AUTO_COMP" = "On" ]
			then
				SLATTACH="$SLATTACH +e"
			fi
		fi

		if [ "$SLIP_FLOW" = "On" ]
		then
			SLATTACH="$SLATTACH +f"
		fi

		if [ "$SLIP_ICMP" = "On" ]
		then
			SLATTACH="$SLATTACH +i"
		fi

		if [ "$SLIP_MTU" ]
		then
			SLATTACH="$SLATTACH -m $SLIP_MTU"
		fi

		if [ "$SLIP_VERB" = "On" ]
		then
			SLATTACH="$SLATTACH +v"
		fi

		if [ "$SLIP_UUCP_NAME" ]
		then
			SLATTACH="$SLATTACH -d $SLIP_UUCP_NAME $SLIP_HOST_IP $SLIP_DEST_IP $SLIP_NM"
		else
			SLATTACH="$SLATTACH $SLIP_TTY $SLIP_HOST_IP $SLIP_DEST_IP $SLIP_NM"
		fi

		if [ "$SLIP_BAUD" ]
		then
			SLATTACH="$SLATTACH $SLIP_BAUD &"
		else
			SLATTACH="$SLATTACH &"
		fi

		#
		# Create a script that contains all the slattach
		# commands to run at system boot.
		#
		if [ ! -f /etc/inet/slip.start ]
		then
			echo "#!/bin/sh" > /etc/inet/slip.start
			echo "#" >> /etc/inet/slip.start
			echo "# DO NOT EDIT THIS FILE!" >> /etc/inet/slip.start
		fi

		if [ "$SLATTACH" ]
		then
			echo "/usr/sbin/slattach $SLATTACH" >> /etc/inet/slip.start
		fi

		grep "^3:" /etc/inet/config > /dev/null 2>&1
		if [ $? -ne 0 ]
		then
			ed -s /etc/inet/config <<-EOF > /dev/null
				\$
				a
				3:/usr/bin/sh::y:/etc/inet/slip.start:/etc/inet/slip.start:
				.
				w
				q
				EOF
		fi

		if [ "$GATEWAY" = "Yes" ]
		then
			inconfig -f /etc/inet/inet.dfl ipforwarding 1
			inconfig -f /etc/inet/inet.dfl ipsendredirects 1
		elif [ "$GATEWAY" = "No" ]
		then
			inconfig -f /etc/inet/inet.dfl ipforwarding 0
			inconfig -f /etc/inet/inet.dfl ipsendredirects 0
		fi

		#
		# If we've got a host name and IP address pair put it in
		# /etc/inet/hosts if it's not already there.
		#
		if [ "$SLIP_LOCAL_NAME" -a "$SLIP_HOST_IP" -a \
			"$SLIP_HOST_IP" != "0.0.0.0" ]
		then
			check_hosts $SLIP_HOST_IP $SLIP_LOCAL_NAME
		fi

		if [ "$SLIP_DEST_NAME" -a "$SLIP_DEST_IP" -a \
			"$SLIP_DEST_IP" != "0.0.0.0" ]
		then
			check_hosts $SLIP_DEST_IP $SLIP_DEST_NAME
		fi
	elif [ "$LINK_TYPE" = "incoming" ]
	then
		. ${TMPDIR}/slip.conf
		rm -f ${TMPDIR}/slip.conf

		/usr/lib/netcfg/bin/addslipuser $SLIP_LOGIN $SLIP_SHELL
	fi

	#
	# If we weren't called from within netconfig don't prompt to continue
	# this will be handled in pppconf.
	#
	if [ ! "$1" ]
	then
		break
	fi

	#
	# Ask if the user wants to continue configuring more links.
	#
	/usr/lib/netcfg/bin/yesno
	result=$?

	if [ $result -eq 1 ]
	then
		break
	fi
done

exit $OK
